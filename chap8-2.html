<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<title>Git In The Trenches</title>
<link href="stylesheet.css" rel="stylesheet" type="text/css">
<link type="text/css" href="menu.css" rel="stylesheet" />
	<script type="text/javascript" src="jquery.js"></script>
</head>

<body>
<table width="1000" border="0" align="center" cellpadding="0" cellspacing="0">
  <tr>
    <td><table width="100%"  border="0" cellspacing="0" cellpadding="0">
      <tr>
        <td><table width="100%"  border="0" cellspacing="0" cellpadding="0">
          <tr>
            <td class="logo"><a href="index.html"><img src="images/git_logo_new.png" alt="Git In The Trenches" height="61" border="0"></a></td>
            <td class="nav">
				<a href="index.html">Home</a>&nbsp;&nbsp;|&nbsp;&nbsp;
				<a href="download.html">Download Now</a>&nbsp;&nbsp;|&nbsp;&nbsp;
				<a href="intro.html">Read Now</a>&nbsp;&nbsp;|&nbsp;&nbsp;
				<a href="http://github.com/cbx33/gitt">Source</a>&nbsp;&nbsp;|&nbsp;&nbsp;
				<a href="feedback.html">Feeback</a>
			</td>
          </tr>
        </table></td>
      </tr>
      <tr>
        <td>&nbsp;</td>
      </tr>
      <tr>
        <td class="main_content_pad"><table width="100%"  border="0" cellspacing="0" cellpadding="0">
          <tr>
            <td width="309"><table width="100%"  border="0" cellspacing="0" cellpadding="0">
              <tr>
                <td class="subnav">
				<strong>Introduction</strong><br>
&bull;&nbsp;&nbsp;<a href="intro.html">How this book works</a><br>
<div class="divider"></div>
<strong>Setting up</strong><br>
&bull;&nbsp;&nbsp;<a href="setup.html">Making sure you have everything</a><br>
<div class="divider"></div>
<strong>Week 1</strong><br>
<span>&bull; Day 1 </span> - <a href="chap1-1.html"> "Things need to change"</a><br>
<span>&bull; Day 3 </span> - <a href="chap1-2.html"> "A possible solution"</a><br>
<span>&bull; Day 4 </span> - <a href="chap1-3.html"> "A decision is reached"</a><br>
<span>&bull; Day 5 </span> - <a href="chap1-4.html"> "Working like a team"</a><br>
<div class="divider"></div>
<strong>After Hours Week 1</strong><br>
&bull;&nbsp;&nbsp;<a href="afterhours1-1.html">"History Lesson"</a><br>
<div class="divider"></div>
<strong>Week 2</strong><br>
<span>&bull; Day 1 </span> - <a href="chap2-1.html"> "We are coders, we use Git!"</a><br>
<span>&bull; Day 2 </span> - <a href="chap2-2.html"> "Making commitments"</a><br>
<span>&bull; Day 4 </span> - <a href="chap2-3.html"> "Let's do this right, not fast"</a><br>
<span>&bull; Summary </span> - <a href="chap2-4.html"> John's Notes</a><br>
<div class="divider"></div>
<strong>After Hours Week 2</strong><br>
&bull;&nbsp;&nbsp;<a href="afterhours2-1.html">"A Little Of Git's Internals"</a><br>
<div class="divider"></div>
<strong>Week 3</strong><br>
<span>&bull; Day 1 </span> - <a href="chap3-1.html"> "How do I see what's going on?"</a><br>
<span>&bull; Day 2 </span> - <a href="chap3-2.html"> "But I need more information"</a><br>
<span>&bull; Day 3 </span> - <a href="chap3-3.html"> "What actually changed?"</a><br>
<span>&bull; Day 4 </span> - <a href="chap3-4.html"> "Finding a good reference point"</a><br>
<span>&bull; Day 5 </span> - <a href="chap3-5.html"> "Putting things back again"</a><br>
<span>&bull; Summary </span> - <a href="chap3-6.html"> John's Notes</a><br>
<div class="divider"></div>
<strong>After Hours Week 3</strong><br>
&bull;&nbsp;&nbsp;<a href="afterhours3-1.html">"A Closer Look At Diffs and Tags"</a><br>
<div class="divider"></div>
<strong>Week 4</strong><br>
<span>&bull; Day 1 </span> - <a href="chap4-1.html"> "We're getting somewhere"</a><br>
<span>&bull; Day 2 </span> - <a href="chap4-2.html"> "Branches galore"</a><br>
<span>&bull; Day 3 </span> - <a href="chap4-3.html"> "Tricking the twigs"</a><br>
<span>&bull; Day 4 </span> - <a href="chap4-4.html"> "I pressed delete..."</a><br>
<span>&bull; Day 5 </span> - <a href="chap4-5.html"> "Conflicting information"</a><br>
<span>&bull; Summary </span> - <a href="chap4-6.html"> John's Notes</a><br>
<div class="divider"></div>
<strong>After Hours Week 4</strong><br>
&bull;&nbsp;&nbsp;<a href="afterhours4-1.html">"Merge merge merge"</a><br>
&bull;&nbsp;&nbsp;<a href="afterhours4-2.html">"Grepping your life away"</a><br>
<div class="divider"></div>
<strong>Week 5</strong><br>
<span>&bull; Day 1 </span> - <a href="chap5-1.html"> "This isn't working for me John"</a><br>
<span>&bull; Day 2 </span> - <a href="chap5-2.html"> "Back to logging"</a><br>
<span>&bull; Day 4 </span> - <a href="chap5-3.html"> "Advanced Techniques"</a><br>
<span>&bull; Summary </span> - <a href="chap5-4.html"> John's Notes</a><br>
<div class="divider"></div>
<strong>After Hours Week 5</strong><br>
&bull;&nbsp;&nbsp;<a href="afterhours5-1.html">"Splitting up commits the easy way"</a><br>
<div class="divider"></div>
<strong>Week 6</strong><br>
<span>&bull; Day 1 </span> - <a href="chap6-1.html"> "My private little stash"</a><br>
<span>&bull; Day 2 </span> - <a href="chap6-2.html"> "What?! No backup?"</a><br>
<span>&bull; Day 3 </span> - <a href="chap6-3.html"> "Is this clone for real?"</a><br>
<span>&bull; Day 4 </span> - <a href="chap6-4.html"> "Help I'm no longer up to date?"</a><br>
<span>&bull; Day 5 </span> - <a href="chap6-5.html"> "I'm putting my foot down"</a><br>
<span>&bull; Summary </span> - <a href="chap6-6.html"> John's Notes</a><br>
<div class="divider"></div>
<strong>After Hours Week 6</strong><br>
&bull;&nbsp;&nbsp;<a href="afterhours6-1.html">"Tug of war"</a><br>
&bull;&nbsp;&nbsp;<a href="afterhours6-2.html">"Referring to objects"</a><br>
<div class="divider"></div>
<strong>Week 7</strong><br>
<span>&bull; Day 1 </span> - <a href="chap7-1.html"> "Networking with a difference"</a><br>
<span>&bull; Day 2 </span> - <a href="chap7-2.html"> "Now let's work together"</a><br>
<span>&bull; Day 3 </span> - <a href="chap7-3.html"> "Rebasing our commitments"</a><br>
<span>&bull; Day 4 </span> - <a href="chap7-4.html"> "Starting to get rebased"</a><br>
<span>&bull; Day 5 </span> - <a href="chap7-5.html"> "I could rebase the world"</a><br>
<span>&bull; Summary </span> - <a href="chap7-6.html"> John's Notes</a><br>
<div class="divider"></div>
<strong>After Hours Week 7</strong><br>
&bull;&nbsp;&nbsp;<a href="afterhours7-1.html">"Network Communicating"</a><br>
<div class="divider"></div>
<strong>Week 8</strong><br>
<span>&bull; Day 1 </span> - <a href="chap8-1.html"> "Give a man a patch"</a><br>
<span>&bull; Day 2 </span> - <a href="chap8-2.html"> "Looking for problems"</a><br>
<span>&bull; Day 3 </span> - <a href="chap8-3.html"> "Filtered repos"</a><br>
<span>&bull; Day 4 </span> - <a href="chap8-4.html"> "Let's make a library"</a><br>
<span>&bull; Day 5 </span> - <a href="chap8-5.html"> "Shhh....we're in a library"</a><br>
<span>&bull; Summary </span> - <a href="chap8-6.html"> John's Notes</a><br>
<div class="divider"></div>
<strong>After Hours Week 8</strong><br>
&bull;&nbsp;&nbsp;<a href="afterhours8-1.html">"Fishing for beginners"</a><br>
<div class="divider"></div>
<strong>A little extra help</strong><br>
&bull;&nbsp;&nbsp;<a href="chap9-1.html">Taking things further</a><br>
&bull;&nbsp;&nbsp;<a href="chap9-2.html">The end of the journey</a><br>
<div class="divider"></div>

				
				<td class="fade_right">&nbsp;</td>
              </tr>
              <tr>
                <td class="fade_bot">&nbsp;</td>
                <td class="fade_corner">&nbsp;</td>
              </tr>
            </table>              <h1>&nbsp;</h1>
              </td>
            <td><table width="100%"  border="0" cellspacing="0" cellpadding="0">
              <tr>
                <td class="read_content">
<h1>Week 8</h1><h2>Day 2 - "Looking for problems"</h2>
<h3>A problem shared is a problem bisected</h3>
During most software development, bugs are introduced.
Sometimes these bugs are fixed immediately and sometimes they sit there in the code festering away for months on end until someone tests a specific case.
Of course it is always best to have test suites and run them regularly against the code base, but on occasions either the test case itself has a bug,
or the test case is written in such a way that a particular bug would never present itself.
Tamagoyaki Inc. have a fairly rigorous testing procedure.
Unfortunately it would seem that one particularly nasty bug has slipped through the cracks.
Cue a difficult discussion.<br><div id="trenchblock"><strong>In the trenches...</strong><br>
"But what I don't understand John, is that you now know what happened at every step in the process.
How can something like this break and you not know about it?"
As always Markus was getting snappy and as always John was having to bite his lip.<br><br>"It's not a question about not knowing about it," begain John, "The difficulty is knowing what change introduced the problem.
We are on such a rapid development schedule that too many things are changing at once."<br><br>"Well, this is one of the reasons you guys have spent the last two months getting this version control system running."
Markus got up and opened the door.  "I suggest you fix it."<br><br> * * * <br><br>"Markus is blaming us for introducing a bug?" Rob was pretty shocked as he and Simon chatted at the water cooler.<br><br>"More like, Markus believed that a version control system was going to solve all of our problems," replied Simon.<br><br>Rob squinted his face up as a car drove into the buildings car park, showering the room with reflected sunlight.
He shielded his eyes. "You know I heard there was a tool in Git for helping to find bugs.
Think I may take a look over lunch, you know, be a real hero."<br><br>They both chuckled.
</div><br>It is true that Git does have a very powerful tool for helping to detect revisions that introduced bugs into the system.
The tool is called <code class="ncode">git bisect</code> and it is used to successively checkout revisions from the repository,
check them to see if the bug is present and then use that information to determine the revision that is most likely to have introduced the bug.<br><br>Let us assume that the bug in our repository is a fairly simple one.
For some bizarre reason our codebase is broken unless the word <code class="ncode">Addition</code> is present in one of the files.
If we run a simple Linux <code class="ncode">grep</code> command across the files, we can see that the word we are after is not there.
However, if we go back to tag <strong>v1.0a</strong> and run the same command, we can see that the word is there.<br><div id="codeblock"><code><strong>john@satsuki:~/coderepo$ grep "Addition" *</strong><br>
<strong>john@satsuki:~/coderepo$ </strong><br>
<strong>john@satsuki:~/coderepo$ git checkout v1.0a </strong><br>
Note: checking out 'v1.0a'.<br>
<br>
You are in 'detached HEAD' state. You can look around, make experimental<br>
changes and commit them, and you can discard any commits you make in this<br>
state without impacting any branches by performing another checkout.<br>
<br>
If you want to create a new branch to retain commits you create, you may<br>
do so (now or later) by using -b with the checkout command again. Example:<br>
<br>
  git checkout -b new_branch_name<br>
<br>
HEAD is now at a022d4d... Messed with a few files<br>
<strong>john@satsuki:~/coderepo$ grep "Addition" *</strong><br>
my_third_committed_file:Addition to the line<br>
<strong>john@satsuki:~/coderepo$ </strong><br>
</code></div><br>Notice the warning about checking out a non-branch.
This is perfectly normal and should not worry you but please be aware that it is obviously best to have a clean working directory before starting any type of <code class="ncode">bisect</code> commands.
We can see that the string we are looking for is present in the file called <code class="ncode">my_third_committed_file</code>.
As our repository is very small, it would not take us long to go through and check each revision to see when this string was deleted.
In fact we have other tools available to search for the adding and removal of strings.
For now let us assume that the <em>bug</em> is more complicated than this.<br><br>Let us go back to the facts.
We know that the repository was <strong>good</strong> at tag <strong>v1.0a</strong>.
We also know that the repository is bad in its current state.
By feeding these details to the <code class="ncode">git bisect</code> command, we can begin a search for the bug.
What will happen at each stage is that Git will checkout a revision that it wants us to test and we tell Git if we think that revision is good or bad.<br><div id="codeblock"><code><strong>john@satsuki:~/coderepo$ git bisect start</strong><br>
Already on 'master'<br>
<strong>john@satsuki:~/coderepo$ git bisect good v1.0a</strong><br>
<strong>john@satsuki:~/coderepo$ git bisect bad master</strong><br>
Bisecting: 9 revisions left to test after this (roughly 3 steps)<br>
[ed2301ba223a63a5a930b536a043444e019460a7] Removed third file<br>
<strong>john@satsuki:~/coderepo$</strong><br>
</code></div><br>So we invoke the tool by running <code class="ncode">git bisect start</code>.
After this we tell Git the things that we know. It was good at <strong>v1.0a</strong>, <code class="ncode">git bisect good v1.0a</code>.
However, it was bad at <strong>master</strong>, our current revision, <code class="ncode">git bisect bad master</code>.
After this, Git checks out revision <strong>ed2301b</strong> and tells us that there are <code class="ncode">9</code> revisions between the two points and that it should take only <code class="ncode">3</code> more steps to complete.
Now we run our test again.<br><div id="codeblock"><code><strong>john@satsuki:~/coderepo$ grep "Addition" *</strong><br>
<strong>john@satsuki:~/coderepo$</strong><br>
</code></div><br>As we have no result here, this would be classed as a bad revision and so we mark it as so.<br><div id="codeblock"><code><strong>john@satsuki:~/coderepo$ git bisect bad</strong><br>
Bisecting: 3 revisions left to test after this (roughly 2 steps)<br>
[9710177657ae00665ca8f8027b17314346a5b1c4] Added another file<br>
<strong>john@satsuki:~/coderepo$</strong><br>
</code></div><br>Git now presents us with a new choice and you can see that the number of revisions left to check has decreased dramatically from <code class="ncode">9</code> to <code class="ncode">3</code>.
We continue marking our revisions as good and bad.<br><div id="codeblock"><code><strong>john@satsuki:~/coderepo$ grep "Addition" *</strong><br>
my_third_committed_file:Addition to the line<br>
<strong>john@satsuki:~/coderepo$ git bisect good</strong><br>
Bisecting: 2 revisions left to test after this (roughly 1 step)<br>
[cfbecabb031696a217b77b0e1285f2d5fc2ea2a3] Fantastic new feature<br>
<strong>john@satsuki:~/coderepo$ grep "Addition" *</strong><br>
my_third_committed_file:Addition to the line<br>
<strong>john@satsuki:~/coderepo$ git bisect good</strong><br>
Bisecting: 0 revisions left to test after this (roughly 1 step)<br>
[b119573f4508514c55e1c4e3bebec0ab3667d071] Merge branch 'wonderful'<br>
<strong>john@satsuki:~/coderepo$ grep "Addition" *</strong><br>
my_third_committed_file:Addition to the line<br>
<strong>john@satsuki:~/coderepo$ git bisect good</strong><br>
ed2301ba223a63a5a930b536a043444e019460a7 is the first bad commit<br>
commit ed2301ba223a63a5a930b536a043444e019460a7<br>
Author: John Haskins &lt;john.haskins@tamagoyakiinc.koala&gt;<br>
Date:   Fri Apr 1 07:37:34 2011 +0100<br>
<br>
    Removed third file<br>
<br>
:100644 000000 68365cc0e5909dc366d31febf5ba94a3268751c6 0000000000000000000000000000000000000000 D	my_third_committed_file<br>
<strong>john@satsuki:~/coderepo$ </strong><br>
</code></div><br>Oh! Something different.  Git has actually finished the bisect and has suggested to us that this commit was responsible for introducing the bug in our code.
If we look at the comment it was in this revision that we removed a particular file.
This file was the one that contained our special <code class="ncode">Addition</code> string.
Git was right! We screwed up then.  At this point we can go back to our <strong>master</strong> branch and decide what to do about it.<br><div id="codeblock"><code><strong>john@satsuki:~/coderepo$ git branch -v</strong><br>
* (no branch) b119573 Merge branch 'wonderful'<br>
  develop     aed985c More new deving<br>
  master      30900fe More new deving<br>
  wonderful   4d91aab Updated another file again<br>
  zaney       7cc32db Made another awesome change<br>
<strong>john@satsuki:~/coderepo$ git checkout master</strong><br>
Previous HEAD position was b119573... Merge branch 'wonderful'<br>
Switched to branch 'master'<br>
<strong>john@satsuki:~/coderepo$</strong><br>
</code></div><br>Notice that at the end of the bisect, Git does not return us to the master branch.
We are left in the last tested checked out revision.<br><h3>Automating the process</h3>
So bisecting is a very powerful way of quickly and efficiently finding the point at which bugs were introduced or regression testing.
Git was spot on when it suggested that that revision was the one responsible for the mistake.
Sometimes you may not be able to test a revision that Git checks out for you for other reasons.
In this case you can always run <code class="ncode">git bisect skip</code> to skip that revision.
It is all very well being able to run this at each revision Git asks us to but to be honest, if you have 30-40 steps to test and you have to compile code to see if the bug is present it can get a little bit boring.<br><br>Git has a way of allowing us to test automatically.
The example we are going to use is obviously based on a Linux environment, but if you are a developer on a Windows platform, you should have no trouble understanding what is happening here.
We are going to create a small shell script that will automatically run our grep test.
If the string is found we will exit with a status code of <code class="ncode">0</code>, indicating that it was successful and if
the string is not found, we will exit with a status code of <code class="ncode">123</code>, indicating that the test was unsuccessful.<br><br>Git will use these status codes and interpret a code of <code class="ncode">0</code> as <strong>good</strong> and a code of <code class="ncode">123</code> as <strong>bad</strong>.
Below is a copy of our shell script which we have saved as <code class="ncode">test.sh</code> and have given relevant permissions to allow it to run etc.
Notice we have had to exclude our <code class="ncode">test.sh</code> file from the test, else the string <code class="ncode">Addition</code> would have been found there.<br><div id="codeblock"><code><strong>john@satsuki:~/coderepo$ cat test.sh </strong><br>
#!/bin/bash<br>
<br>
if grep -q Addition * --exclude=test.sh<br>
  then echo "Good"<br>
  exit 0<br>
else <br>
  echo "Bad"<br>
  exit 123<br>
fi<br>
<strong>john@satsuki:~/coderepo$ </strong><br>
</code></div><br>Now we invoke <code class="ncode">git bisect</code> slightly differently by asking it to start and itterate over the revisions <code class="ncode">master</code> to <code class="ncode">v1.0a</code>.
At this point we have not told Git anything about which revisions are good or bad.<br><div id="codeblock"><code><strong>john@satsuki:~/coderepo$ git bisect start master v1.0a</strong><br>
Bisecting: 9 revisions left to test after this (roughly 3 steps)<br>
[ed2301ba223a63a5a930b536a043444e019460a7] Removed third file<br>
<strong>john@satsuki:~/coderepo$</strong><br>
</code></div><br>Now we ask Git to continue testing, but to run our script at each iteration to determine the success or failure of each checked out revision.<br><div id="codeblock"><code><strong>john@satsuki:~/coderepo$ git bisect run sh ./test.sh</strong><br>
running sh ./test.sh<br>
Bad<br>
Bisecting: 3 revisions left to test after this (roughly 2 steps)<br>
[9710177657ae00665ca8f8027b17314346a5b1c4] Added another file<br>
running sh ./test.sh<br>
Good<br>
Bisecting: 2 revisions left to test after this (roughly 1 step)<br>
[cfbecabb031696a217b77b0e1285f2d5fc2ea2a3] Fantastic new feature<br>
running sh ./test.sh<br>
Good<br>
Bisecting: 0 revisions left to test after this (roughly 1 step)<br>
[b119573f4508514c55e1c4e3bebec0ab3667d071] Merge branch 'wonderful'<br>
running sh ./test.sh<br>
Good<br>
ed2301ba223a63a5a930b536a043444e019460a7 is the first bad commit<br>
commit ed2301ba223a63a5a930b536a043444e019460a7<br>
Author: John Haskins &lt;john.haskins@tamagoyakiinc.koala&gt;<br>
Date:   Fri Apr 1 07:37:34 2011 +0100<br>
<br>
    Removed third file<br>
<br>
:100644 000000 68365cc0e5909dc366d31febf5ba94a3268751c6 0000000000000000000000000000000000000000 D	my_third_committed_file<br>
bisect run success<br>
<strong>john@satsuki:~/coderepo$ </strong><br>
</code></div><br>The parameters after the <code class="ncode">git bisect run</code> tell Git which command we wish to run at each stage.
In our case it is <code class="ncode">sh ./test.sh</code>.
You can see Git invoking our <code class="ncode">test.sh</code> script in each case, and the result of our script, either <code class="ncode">Good</code> or <code class="ncode">Bad</code> depending on which was echoed from the result of the grep test.
Git has arrived at exactly the same result, but we have had to do nothing other than write a small script.
For larger tests, this would have saved us a large amount of work.<br><div id="trenchblock"><strong>In the trenches...</strong><br>
"Simon could I have a word?" It was Rob and he wasn't looking happy.<br><br>Simon turned to him and grinned, "Sure buddy what's up?"  His face dropped when he saw Rob's expression.<br><br>"I think we'd better go grab the meeting room."<br><br>Simon looked confused.<br><br>"I used the bisect tool to find the bug.  But you're not gonna like what I found."<br><br> * * * <br><br>"Simon how could you have done that?" John was asking the questions and they were coming thick and fast.
"I mean changing the API key for the web sevice whilst developing was not a great idea to start with, but committing that to the repository was rediculous."
Simon sat there with his head in his hands.
"You know how secret that API key is right?" Simon nodded.
"Simon we were supposed to be releasing this repository publically in a few weeks but now that the API is in there we can't do that."<br><br>"John I'm really sorry OK." Simon was kicking himself for his mistake.<br><br>John sighed, he had been really angry to begin with but now he was calming down,
"It's OK Simon, we're all getting used to the repository and version control.  Do you think we can fix it?"
</div><br><table border="0" cellpadding="0" cellspacing="0" width="100%">
					<tr>
						<td><p align="left"><a href="chap8-1.html"><img src="images/prev.png" alt="Previous Day" height="29" border="0"></a></p></td>
						<td><p align="right"><a href="chap8-3.html"><img src="images/next.png" alt="Next Day" height="29" border="0"></a></p></td>
					</tr>
				</table>                  </td>
                <td class="fade_right">&nbsp;</td>
              </tr>
              <tr>
                <td class="fade_bot">&nbsp;</td>
                <td class="fade_corner">&nbsp;</td>
              </tr>
            </table></td>
            </tr>
          </table>
		</td>
      </tr>
      <tr>
        <td class="foot"><a href="index.html">home</a> | <a href="download.html">download</a> | <a href="read.html">read now</a> | <a href="source.html">source</a> | <a href="feedback.html">feedback</a> | <a href="legal.html">legal stuff</a><br>
        </td>
      </tr>
    </table></td>
  </tr>
</table>
</body>
</html>
